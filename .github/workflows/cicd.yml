# GitHub Actions에서 보일 워크플로우 이름
# 이 레포가 "인프라 설정 검증용"이라는 목적을 드러냄
name: Validate Infra Config

# 언제 이 워크플로우를 실행할지 정의
on:
  # main 브랜치에 push 될 때
  push:
    branches: ["main"]

  # PR 생성/수정 시
  pull_request:

jobs:
  validate:
    # GitHub가 제공하는 Ubuntu 러너에서 실행
    runs-on: ubuntu-latest

    steps:
      # 1. 현재 레포를 러너에 체크아웃
      - uses: actions/checkout@v4

      # 2. CI 전용 더미 env 파일 생성
      # 실제 서버/로컬 비밀값을 쓰지 않고,
      # docker compose가 ${VAR} 치환을 끝까지 수행할 수 있도록
      # "형태만 맞는" 가짜 값을 채워준다.
      # 목적: 실행이 아니라 "구문/구조 검증"이 가능하게 만드는 것
      - name: Create dummy env for CI
        run: |
          echo "TZ=Asia/Seoul" > .env.ci
          echo "POSTGRES_USER=dummy" >> .env.ci
          echo "POSTGRES_PASSWORD=dummy" >> .env.ci
          echo "POSTGRES_DB=dummy" >> .env.ci
          echo "N8N_BASIC_AUTH_USER=dummy" >> .env.ci
          echo "N8N_BASIC_AUTH_PASSWORD=dummy" >> .env.ci
          echo "N8N_HOST=example.com" >> .env.ci
          echo "N8N_PROTOCOL=http" >> .env.ci
          echo "WEBHOOK_URL=http://example.com" >> .env.ci
          echo "N8N_ENCRYPTION_KEY=dummykey" >> .env.ci

      # 3. 로컬용 docker-compose 파일 검증
      # 실제 컨테이너를 띄우지 않고,
      # YAML 문법, 키 구조, 변수 치환 가능 여부만 검사한다.
      - name: Validate docker-compose (local)
        run: docker compose --env-file .env.ci -f docker-compose.local.yml config

      # 4. 서버용 docker-compose 파일 검증
      - name: Validate docker-compose (server)
        run: docker compose --env-file .env.ci -f docker-compose.server.yml config

      # 5. nginx 설정 파일 문법 검증 (선택)
      # nginx 컨테이너를 잠깐 실행해 `nginx -t`로 설정 유효성만 검사
      - name: Validate nginx config
        run: |
          docker run --rm \
            -v $PWD/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
            nginx:alpine nginx -t
