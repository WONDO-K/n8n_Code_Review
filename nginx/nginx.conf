# nginx는 기본적으로 events 블록이 필요하다.
# (실제 트래픽 처리는 http 블록에서 이뤄짐)
events {}

http {
  # n8n을 가리키는 업스트림 그룹
  # 현재는 n8n 컨테이너 1대만 연결되어 있음
  upstream n8n_upstream {
    server n8n:5678;
    # 추후 n8n을 여러 대로 확장할 경우 아래처럼 늘릴 수 있다.
    # server n8n-1:5678;
    # server n8n-2:5678;
    # 이렇게 하면 nginx가 로드밸런싱 역할을 수행하게 된다.
  }

  server {
    # 외부에서 들어오는 HTTP 요청을 80 포트에서 수신
    listen 80;

    # 모든 요청을 루트(/) 기준으로 n8n에 그대로 전달
    # n8n은 서브 디렉터리(/n8n 등)에서 동작하지 않기 때문에
    # 반드시 루트에 매핑해야 정상 동작한다.
    location / {
      proxy_pass http://n8n_upstream;

      # 원본 요청 정보를 n8n에 전달
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # Webhook, SSE, WebSocket 안정성 확보용 설정
      # n8n은 실시간 이벤트(SSE, Webhook 응답 유지)를 사용하므로 필수
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }
  }
}
